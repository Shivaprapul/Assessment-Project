// Prisma Schema for Student Assessment & Career Support Platform
// Multi-tenant architecture with Row-Level Security support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= CORE TENANT MODELS =============

model Tenant {
  id                String   @id @default(uuid())
  name              String
  type              TenantType
  subdomain         String   @unique
  customDomain      String?
  branding          Json     @default("{}")
  features          Json     @default("{}")
  subscription      Json     @default("{}")
  dataRetentionDays Int      @default(730)
  isActive          Boolean  @default(true)
  deletedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  users             User[]
  students          StudentProfile[]
  activities        Activity[]
  
  @@index([subdomain])
  @@map("tenants")
}

enum TenantType {
  SCHOOL
  B2C
  @@map("tenant_type")
}

model User {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email         String
  role          UserRole
  name          String
  phone         String?
  avatar        String?
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  studentProfile  StudentProfile?
  consentRecords  ConsentRecord[]
  auditLogs       AuditLog[]
  
  @@unique([tenantId, email])
  @@index([tenantId, role])
  @@map("users")
}

enum UserRole {
  STUDENT
  PARENT
  TEACHER
  SCHOOL_ADMIN
  PLATFORM_ADMIN
  @@map("user_role")
}

// ============= STUDENT MODELS =============

model StudentProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId            String
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  grade               Int
  section             String?
  dateOfBirth         DateTime
  parentIds           String[]
  teacherIds          String[]
  goals               String[] @default([])
  preferredMode       Mode?
  onboardingComplete  Boolean  @default(false)
  assessmentComplete  Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  assessmentAttempts  AssessmentAttempt[]
  skillScores         SkillScore[]
  aiReports           AIReport[]
  behavioralEvents    BehavioralEvent[]
  activityAttempts    ActivityAttempt[]
  
  @@index([tenantId])
  @@index([grade])
  @@map("student_profiles")
}

enum Mode {
  EXPLORER
  FACILITATOR
  @@map("mode")
}

// ============= ASSESSMENT MODELS =============

model AssessmentAttempt {
  id               String   @id @default(uuid())
  studentId        String
  student          StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenantId         String
  gameId           String
  attemptNumber    Int      @default(1)
  startedAt        DateTime @default(now())
  completedAt      DateTime?
  status           AttemptStatus @default(IN_PROGRESS)
  telemetry        Json     @default("{}")
  rawScores        Json     @default("{}")
  normalizedScores Json     @default("{}")
  reflectionText   String?  @db.Text
  metadata         Json     @default("{}")
  
  @@index([studentId, gameId])
  @@index([tenantId])
  @@map("assessment_attempts")
}

enum AttemptStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  @@map("attempt_status")
}

model SkillScore {
  id            String   @id @default(uuid())
  studentId     String
  student       StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenantId      String
  category      SkillCategory
  score         Float
  level         SkillLevel
  evidence      String[] @default([])
  trend         Trend
  lastUpdatedAt DateTime @default(now())
  history       Json     @default("[]")
  
  @@unique([studentId, category])
  @@index([tenantId])
  @@map("skill_scores")
}

enum SkillCategory {
  COGNITIVE_REASONING
  CREATIVITY
  LANGUAGE
  MEMORY
  ATTENTION
  PLANNING
  SOCIAL_EMOTIONAL
  METACOGNITION
  CHARACTER_VALUES
  @@map("skill_category")
}

enum SkillLevel {
  EMERGING
  DEVELOPING
  PROFICIENT
  ADVANCED
  @@map("skill_level")
}

enum Trend {
  IMPROVING
  STABLE
  NEEDS_ATTENTION
  @@map("trend")
}

model AIReport {
  id              String   @id @default(uuid())
  studentId       String
  student         StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenantId        String
  reportType      ReportType
  generatedAt     DateTime @default(now())
  studentInsights Json     @default("{}")
  parentGuidance  Json     @default("{}")
  evidenceUsed    String[] @default([])
  metadata        Json     @default("{}")
  
  @@index([studentId, reportType])
  @@index([tenantId])
  @@map("ai_reports")
}

enum ReportType {
  INITIAL_ASSESSMENT
  MONTHLY_PROGRESS
  GOAL_REVIEW
  @@map("report_type")
}

// ============= BEHAVIORAL TIMELINE =============

model BehavioralEvent {
  id            String   @id @default(uuid())
  studentId     String
  student       StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenantId      String
  timestamp     DateTime @default(now())
  eventType     EventType
  context       String
  sourceGameId  String?
  studentChoice String   @db.Text
  aiAnalysis    Json     @default("{}")
  visibility    Visibility
  metadata      Json     @default("{}")
  
  @@index([studentId, timestamp])
  @@index([tenantId])
  @@map("behavioral_events")
}

enum EventType {
  ETHICAL_DECISION
  REFLECTION
  ADAPTABILITY
  RISK_TAKING
  EMPATHY
  PERSISTENCE
  @@map("event_type")
}

enum Visibility {
  STUDENT_ONLY
  STUDENT_AND_PARENT
  ALL
  @@map("visibility")
}

// ============= ACTIVITY MODELS =============

model Activity {
  id              String   @id @default(uuid())
  tenantId        String?
  tenant          Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  title           String
  description     String   @db.Text
  mode            String[] // Array of Mode enum values
  type            ActivityType
  targetCategories String[]
  difficulty      Int
  estimatedTime   Int
  content         Json     @default("{}")
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  attempts        ActivityAttempt[]
  
  @@index([tenantId])
  @@index([difficulty])
  @@map("activities")
}

enum ActivityType {
  DISCOVERY_QUEST
  DAILY_CHALLENGE
  SKILL_BUILDER
  REFLECTION
  MILESTONE
  @@map("activity_type")
}

model ActivityAttempt {
  id            String   @id @default(uuid())
  studentId     String
  student       StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenantId      String
  activityId    String
  activity      Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  mode          Mode
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  status        AttemptStatus
  telemetry     Json     @default("{}")
  aiAssessment  Json?
  reflectionText String?  @db.Text
  
  @@index([studentId, mode])
  @@index([tenantId])
  @@map("activity_attempts")
}

// ============= COMPLIANCE MODELS =============

model ConsentRecord {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjectUserId   String
  tenantId        String
  purpose         ConsentPurpose
  granted         Boolean
  timestamp       DateTime @default(now())
  ipAddress       String
  userAgent       String
  expiresAt       DateTime?
  withdrawnAt     DateTime?
  metadata        Json     @default("{}")
  
  @@index([subjectUserId, purpose])
  @@index([tenantId])
  @@map("consent_records")
}

enum ConsentPurpose {
  ASSESSMENT
  DATA_PROCESSING
  AI_ANALYSIS
  PARENT_VISIBILITY
  TEACHER_VISIBILITY
  RESEARCH
  @@map("consent_purpose")
}

model AuditLog {
  id            String   @id @default(uuid())
  tenantId      String
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action        Action
  resourceType  ResourceType
  resourceId    String
  ipAddress     String
  userAgent     String
  timestamp     DateTime @default(now())
  success       Boolean
  errorMessage  String?  @db.Text
  metadata      Json     @default("{}")
  
  @@index([tenantId, timestamp])
  @@index([userId, timestamp])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

enum Action {
  CREATE
  READ
  UPDATE
  DELETE
  EXPORT
  @@map("action")
}

enum ResourceType {
  STUDENT
  ASSESSMENT
  REPORT
  CONSENT
  ACTIVITY
  @@map("resource_type")
}

// ============= NEXT-AUTH MODELS =============

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
